services:
  # =============================================================================
  # Frontend - React SPA served by Nginx
  # =============================================================================
  frontend:
    image: ghcr.io/jack-jackhui/winning-cv:frontend
    container_name: winning-cv-frontend
    restart: unless-stopped
    ports:
      - "13000:80"  # Only frontend exposed externally
    depends_on:
      api:
        condition: service_healthy
    networks:
      - winningcv-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =============================================================================
  # FastAPI Backend - Internal only (accessed via nginx proxy)
  # =============================================================================
  api:
    image: ghcr.io/jack-jackhui/winning-cv:latest
    container_name: winning-cv-api
    restart: unless-stopped
    # NO external ports - accessed via frontend nginx proxy
    volumes:
      - ./user_cv:/winning-cv/user_cv
      - cv_data:/winning-cv/customised_cv
    environment:
      - API_PORT=8000
      - API_HOST=0.0.0.0
      - API_RELOAD=false
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - CHROMIUM_PATH=/usr/bin/chromium
      - HEADLESS=true
      - MINIO_ENDPOINT=minio:9000
    env_file:
      - .env
    depends_on:
      minio:
        condition: service_healthy
    command: ["python", "run_api.py"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - winningcv-net

  # =============================================================================
  # CLI Job Runner - For cronjob execution
  # =============================================================================
  job-runner:
    image: ghcr.io/jack-jackhui/winning-cv:latest
    restart: "no"
    user: "${UID}:${GID}"
    volumes:
      - ./user_cv:/winning-cv/user_cv
      - cv_data:/winning-cv/customised_cv
    environment:
      - CHROMIUM_PATH=/usr/bin/chromium
      - HEADLESS=true
      - MINIO_ENDPOINT=minio:9000
    env_file:
      - .env
    command: ["python", "main.py", "--user-email", "${JOB_USER_EMAIL}"]
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - winningcv-net
    profiles:
      - cli  # Only run when explicitly requested: docker compose --profile cli run job-runner

  # =============================================================================
  # MinIO Object Storage - Internal only
  # =============================================================================
  minio:
    image: minio/minio:latest
    container_name: winning-cv-minio
    restart: unless-stopped
    # NO external ports - internal only
    # Uncomment below for admin console access (localhost only)
    # ports:
    #   - "127.0.0.1:9001:9001"
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin123}
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - winningcv-net

  # =============================================================================
  # MinIO Bucket Initialization
  # =============================================================================
  minio-init:
    image: minio/mc:latest
    container_name: winning-cv-minio-init
    restart: "no"
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      sleep 5;
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER:-minioadmin} $${MINIO_ROOT_PASSWORD:-minioadmin123};
      mc mb myminio/winningcv-cvs --ignore-existing;
      mc anonymous set none myminio/winningcv-cvs;
      echo 'MinIO bucket initialized successfully';
      "
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin123}
    networks:
      - winningcv-net

# =============================================================================
# Networks
# =============================================================================
networks:
  winningcv-net:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  cv_data:
  minio_data:
